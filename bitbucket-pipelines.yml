definitions:
  steps:
    - step: &Env
        name: Environment
        image: node:16
        script:
          - VER=$(node --version) && echo "Node ver: ${VER}"
          - VER=$(npm --version) && echo "npm ver: ${VER}"
    - step: &DownloadDeps
        name: Download Deps
        image: node:16
        script:
          - npm ci
    - step: &Build
        name: Build
        image: node:16
        script:
          - npm run build
    - step: &InstallArc
        name: Install Arc
        script:
          - npm i -g @architect/architect
    - step: &DeployActingDEV
        name: Deploy acting-dev
        script:
          - arc deploy --acting-dev --prune          
    - step: &DeployActingQA
        name: Deploy acting-qa
        script:
          - arc deploy --acting-qa --prune  
    - step: &DeployStaging
        name: Deploy staging
        script:
          - arc deploy --staging --prune  
    - step: &DeployProduction
        name: Deploy production
        script:
          - arc deploy --production --prune  

pipelines:
  branches:
    develop:
      - step: *Env
      - step: *DownloadDeps
      - step: *Build
      - step: *InstallArc
      - step:
          <<: *DeployActingDEV
          name: acting-dev
          deployment: acting-dev
          trigger: manual
      - step:
          <<: *DeployActingQA
          name: acting-qa
          deployment: acting-qa
          trigger: manual
    main:
      - step: *Env
      - step: *DownloadDeps
      - step: *Build
      - step: *InstallArc
      - step:
          <<: *DeployStaging
          name: staging
          deployment: staging
          trigger: manual
      - step:
          <<: *DeployProduction
          name: prod
          deployment: prod
          trigger: manual
